---
title: "Regression"
author: "Nate Lant"
date: "4/6/2020"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

mydata1 <- read_rds("data/mydata.rds")
```

## Reduced Model

At the most basic level, the binomial regression is the same as the odds ratio. The logit is $z$ in 
$$  z = \beta_0 + \beta_1*x_1 $$

The odds ratio can be calculated using $e^\beta$. This is not to be confused with the odds,
defined as $e^z$

```{r reduced}
glm(worker ~ wheelchair, data = mydata1, family = binomial(link='logit')) %>%
  summary()
```

The usefulness of the model is that we can include more variables in the logit model.


## Full Model

```{r full}
glm(worker ~ wheelchair + educ + r_sex + log(inc_cont) + msasize + r_race, 
    data = mydata1, family = "binomial") %>%
  summary()

glm(worker ~ wheelchair + educ + r_sex + log(inc_cont), 
    data = mydata1, family = "binomial") %>%
  summary()

glm(worker ~ educ*wheelchair + r_sex*wheelchair, 
    data = mydata1, family = "binomial") %>%
  summary()
```

Education does not affect employment for wheelchair users any differently than for wheelchair users.

## Interactions

```{r interaction}
glm(worker ~ wheelchair*poly(r_age, 2, raw=T), 
    data = mydata1, family = "binomial") %>%
  summary()

glm(worker ~ wheelchair*msasize, 
    data = mydata1, family = "binomial") %>%
  summary()
```


## Binary Age Coefficient Plot

```{r loop, message=F, warning=F}
# turns age into a binary variable: older than x, 0 or 1
coefficients <- list()

for(i in 30:63){
  # munging
  df <- mydata1 %>%
    mutate(age_bar = ifelse(r_age > i, T, F))
  # Estimate model
  
  fit <- glm(worker ~ wheelchair*age_bar, data = df, family = "binomial") %>%
    summary()
  
  out_element <- list(
    "i" = i,
    #M:age_barTRUE (coef represents liklihood to take M trip if over age i)
    "coefficient_c" = fit$coefficients[3, 1],
    "coefficient_int" = fit$coefficients[4, 1],
    "stderror_c" = fit$coefficients[3, 2],
    "stderror_int" = fit$coefficients[4, 2]
  )
  
  coefficients[[i]] <- out_element
}

dplyr::bind_rows(coefficients) %>%
  gather(variable, value, -i) %>%
  separate(variable, c("type", "interaction")) %>%
  spread(type, value) %>%
  ggplot(aes(x = i, y = coefficient, group = interaction)) +
  geom_ribbon(aes(ymin = coefficient - 1.96 * stderror,
                  ymax = coefficient + 1.96*stderror),
              alpha = 0.2) +
  geom_line(aes(color = interaction, linetype = interaction)) + 
  scale_color_manual(values = c("darkred", "steelblue")) +
  ggtitle("DAP ~ 1| age_bar", 
          subtitle = "Likelihood for employment OLDER than given age") +
  ylab("Coefficient") +
  xlab("Age")
```

It shows that for wheelchair users, likelihood of employment increases with age. Well this
might make sense because older people have wheelchairs...

```{r}
mydata1 %>%
  filter(wheelchair == 1) %>%
  ggplot(aes(x = as_factor(worker), y = r_age)) +
  geom_violin()
```


